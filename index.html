<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Miglior åº«å­˜ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #2563eb; 
    --bg-body: #f1f5f9;
    --surface: #ffffff;
    --text-main: #1e293b;
    --border: #e2e8f0;
    --safe-bottom: env(safe-area-inset-bottom);
  }
  body { 
    font-family: 'Inter', sans-serif; 
    background: var(--bg-body); 
    color: var(--text-main);
    -webkit-tap-highlight-color: transparent;
    -webkit-overflow-scrolling: touch;
    padding-bottom: calc(20px + var(--safe-bottom));
  }
  
  .sticky-header { 
    position: sticky; top: 0; z-index: 50; background: var(--surface); 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px 16px; 
    display: flex; justify-content: space-between; align-items: center; 
  }
  
  #filterBar { position: sticky; top: 60px; z-index: 40; margin-bottom: 16px; }
  
  .btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 14px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 4px; touch-action: manipulation; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:active { background: #1d4ed8; }
  .btn-ghost { background: transparent; color: #64748b; }
  .btn-ghost:active { background: #f8fafc; color: #0f172a; }
  .btn-outline { background: white; border-color: var(--border); }
  
  .nav-pills { 
    display: flex; gap: 8px; overflow-x: auto; padding: 10px 16px; 
    background: #fff; border-bottom: 1px solid var(--border); scrollbar-width: none; 
  }
  .nav-pills::-webkit-scrollbar { display: none; }
  .nav-item { padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #64748b; cursor: pointer; white-space: nowrap; font-weight: 500; transition: all 0.2s; }
  .nav-item:active { background: #f1f5f9; }
  .nav-item.active { background: #1e293b; color: white; }

  .sub-tabs { display: flex; gap: 4px; margin-bottom: 12px; background: #e2e8f0; padding: 4px; border-radius: 8px; width: fit-content; max-width: 100%; overflow-x: auto; }
  .sub-tab { padding: 8px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; color: #64748b; cursor: pointer; transition: 0.2s; white-space: nowrap; }
  .sub-tab.active { background: white; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

  .card { background: var(--surface); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .hidden { display: none !important; }
  
  .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .data-table th { background: #f8fafc; padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); white-space: nowrap; }
  .data-table td { padding: 10px; border-bottom: 1px solid var(--border); }
  .sticky-head th { position: sticky; top: 0; z-index: 10; }
  .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; max-height: 65vh; border: 1px solid var(--border); border-radius: 8px; }

  .wh-block { margin-bottom: 24px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #fff; }
  .wh-header { background: #f8fafc; padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #2563eb; flex-wrap: wrap; gap: 8px; }
  
  .prod-row { display: flex; flex-direction: column; gap: 16px; padding: 16px; border-bottom: 1px solid var(--border); }
  @media (min-width: 1024px) { .prod-row { display: grid; grid-template-columns: 300px 1fr; gap: 24px; padding: 20px; } }

  .size-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  @media (min-width: 480px) { .size-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (min-width: 768px) { .size-grid { grid-template-columns: repeat(4, 1fr); } }

  .size-box { border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; background: #fafafa; display: flex; flex-direction: column; gap: 8px; }
  
  .qty-input { 
    width: 100%; font-size: 18px; border: 2px solid #cbd5e1; border-radius: 6px; padding: 8px 4px; text-align: center; font-weight: 600; transition: border-color 0.3s; 
    appearance: none; -moz-appearance: textfield; 
  }
  .qty-input:focus { outline: none; border-color: #3b82f6; }
  .qty-positive { background: #ecfdf5; color: #047857; }
  .qty-saving { border-color: #eab308 !important; } 
  .qty-saved { border-color: #22c55e !important; }
  .qty-error { border-color: #ef4444 !important; }
  
  .remark-select { font-size: 14px; padding: 6px; border: 1px solid #e2e8f0; border-radius: 6px; width: 100%; background: white; color: #64748b; height: 36px; }

  .action-btn-group button { padding: 6px 12px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 16px; }

  #toast { position: fixed; bottom: 80px; right: 24px; left: 24px; margin: auto; max-width: 300px; text-align: center; background: rgba(16, 185, 129, 0.95); color: white; padding: 12px 20px; border-radius: 50px; transform: translateY(150px); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; box-shadow: 0 4px 12px rgba(0,0,0,0.15); backdrop-filter: blur(4px); }
  #toast.show { transform: translateY(0); }
  
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(2px); padding: 16px; }
  .modal-box { background: white; padding: 24px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  
  #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .spinner { width: 44px; height: 44px; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
  @media (min-width: 640px) { .stats-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
  
  .stat-card { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); text-align: center; transition: 0.2s; }
</style>
</head>
<body class="bg-slate-50">

<div id="loadingOverlay" class="hidden">
  <div class="spinner"></div>
  <div id="loadingText" class="text-blue-600 font-bold text-lg">è™•ç†ä¸­...</div>
</div>

<div id="loginScreen" class="flex items-center justify-center min-h-screen p-4">
  <div class="card w-full max-w-sm text-center shadow-lg">
    <h2 class="text-2xl font-bold mb-6 text-blue-700">Miglior åº«å­˜ç³»çµ±</h2>
    <input id="loginUser" class="w-full p-3 border rounded-lg mb-4 text-base" placeholder="å¸³è™Ÿ" autocapitalize="none" />
    <input id="loginPw" type="password" class="w-full p-3 border rounded-lg mb-6 text-base" placeholder="å¯†ç¢¼" />
    <button id="loginBtn" class="btn btn-primary w-full py-3 text-base">ç™»å…¥</button>
    <div id="loginMsg" class="text-red-500 text-sm mt-4 font-medium"></div>
  </div>
</div>

<div id="app" class="max-w-7xl mx-auto hidden pb-10">
  <header class="sticky-header">
    <div class="flex items-center gap-2">
      <div class="font-bold text-lg text-blue-700">ğŸ“¦ Miglior Stock</div>
      <span id="userLabel" class="text-xs bg-blue-50 px-2 py-1 rounded text-blue-600 font-medium"></span>
    </div>
    <button id="logoutBtn" class="btn btn-ghost text-sm px-2">ç™»å‡º</button>
  </header>

  <div class="nav-pills rounded-lg mb-4 mx-2">
    <div class="nav-item active" data-target="summarySection">ğŸ“¦ ç¸½è¡¨åº«å­˜</div>
    <div class="nav-item" data-target="allStatsSection">ğŸ“Š å…¨å€‰çµ±è¨ˆ</div>
    <div class="nav-item" data-target="salesSection">ğŸ›’ éŠ·å”®çµ±è¨ˆ</div>
    <div class="nav-item" data-target="addProductSection">ğŸ‘˜ æ–°å¢å•†å“</div>
    <div class="nav-item" data-target="logSection">ğŸ“œ ç´€éŒ„æŸ¥è©¢</div>
    <div class="nav-item hidden" id="navSettings" data-target="settingsSection">âš™ï¸ è¨­å®š</div>
  </div>

  <main class="px-2">
    <div id="filterBar" class="card flex flex-col sm:flex-row gap-3 shadow-md">
      <input id="searchKey" placeholder="ğŸ” æœå°‹... (ç©ºç™½åˆ†éš”)" class="p-3 border rounded-lg flex-1 min-w-0 text-base" />
      <div class="flex gap-2">
        <select id="filterWh" class="p-2 border rounded-lg bg-white flex-1 text-sm h-11"><option value="">å…¨éƒ¨å€‰åº«</option></select>
        <select id="filterCat" class="p-2 border rounded-lg bg-white flex-1 text-sm h-11"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
        <button id="refreshBtn" class="btn btn-ghost border border-gray-200 h-11 w-11 flex-none rounded-lg text-lg">â³</button>
      </div>
    </div>

    <section id="summarySection">
      <div class="sub-tabs mx-auto">
        <div class="sub-tab active" onclick="switchSummaryTab('active')">ç¾è²¨å•†å“</div>
        <div class="sub-tab" onclick="switchSummaryTab('discontinued')">ä¸‹æ¶å•†å“</div>
      </div>
      <div id="summaryContainer"></div>
    </section>

    <section id="allStatsSection" class="hidden">
      <div class="card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
          <h3 class="font-bold text-lg">å…¨å€‰ç¾è²¨çµ±è¨ˆ</h3>
          <div class="flex gap-2 w-full sm:w-auto">
            <input id="allStatsSearch" placeholder="ğŸ” æœå°‹..." class="p-2 border rounded text-sm flex-1 sm:w-48" />
            <button id="exportCsvBtn" class="btn btn-outline text-sm whitespace-nowrap">åŒ¯å‡º CSV</button>
          </div>
        </div>
        <div id="allStatsSummary" class="mb-4"></div>
        <div id="allStatsContainer"></div>
      </div>
    </section>

    <section id="salesSection" class="hidden">
      <div class="card bg-amber-50 border-amber-200 mb-4"><h3 class="font-bold text-amber-800 text-center">ğŸ›’ éŠ·å”®å°ˆå€</h3></div>
      <div id="salesContainer"></div>
    </section>

    <section id="addProductSection" class="hidden">
      <div class="card max-w-2xl mx-auto">
        <h3 class="font-bold mb-4 text-lg">æ–°å¢å•†å“</h3>
        <p class="text-xs text-gray-500 mb-4">* ç³»çµ±å°‡è‡ªå‹•åœ¨æ‰€æœ‰å€‰åº«å»ºç«‹åº«å­˜ï¼Œæœªå¡«å¯«æ•¸é‡å‰‡é è¨­ç‚º 0</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          <label class="block text-sm font-medium">åˆ†é¡ <select id="addCatSelect" class="w-full p-3 border rounded-lg mt-1 bg-white"></select></label>
          <label class="block text-sm font-medium">åç¨± <input id="addName" class="w-full p-3 border rounded-lg mt-1" /></label>
          <label class="block text-sm font-medium">é¡è‰² <input id="addColor" class="w-full p-3 border rounded-lg mt-1" /></label>
          <label class="block text-sm font-medium">å”®åƒ¹ <input id="addPrice" type="number" inputmode="numeric" class="w-full p-3 border rounded-lg mt-1" /></label>
          <label class="block sm:col-span-2 text-sm font-medium">èªªæ˜ <select id="addDescSelect" class="w-full p-3 border rounded-lg mt-1 bg-white"></select></label>
        </div>
        <button id="genSizeTableBtn" class="btn btn-primary w-full py-3">è¨­å®šåº«å­˜æ•¸é‡ (é¸å¡«)</button>
        <div id="addSizeTable" class="mt-4 hidden overflow-x-auto"></div>
      </div>
    </section>

    <section id="logSection" class="hidden">
      <div class="card">
        <h3 class="font-bold mb-4">ç´€éŒ„æŸ¥è©¢</h3>
        <div class="grid grid-cols-2 gap-2 mb-4">
          <input type="date" id="logStart" class="border p-2 rounded w-full">
          <input type="date" id="logEnd" class="border p-2 rounded w-full">
          <select id="logTypeFilter" class="border p-2 rounded bg-white w-full col-span-1">
            <option value="">æ‰€æœ‰é¡å‹</option>
            <option value="sale">éŠ·å”®</option>
            <option value="transfer">èª¿æ’¥</option>
            <option value="modify">åº«å­˜ä¿®æ”¹</option>
          </select>
          <select id="logWhFilter" class="border p-2 rounded w-full col-span-1"><option value="">ä¸é™å€‰åº«</option></select>
          <button id="logQueryBtn" class="btn btn-primary col-span-2 py-2">æŸ¥è©¢</button>
        </div>
        <div class="table-container"><table class="data-table sticky-head"><thead id="logThead"></thead><tbody id="logTbody"></tbody></table></div>
      </div>
    </section>

    <section id="settingsSection" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <h4 class="font-bold mb-2 text-blue-800">ğŸ­ å€‰åº«ç®¡ç†</h4>
          <div class="flex gap-2 mb-2"><input id="newWhName" placeholder="åç¨±" class="p-2 border rounded flex-1"><input id="newWhLoc" placeholder="åœ°é»" class="p-2 border rounded flex-1"><button id="addWhBtn" class="btn btn-primary">æ–°å¢</button></div>
          <div id="whList" class="max-h-60 overflow-y-auto space-y-2"></div>
        </div>
        <div class="card">
          <h4 class="font-bold mb-2 text-blue-800">ğŸ“‚ åˆ†é¡ç®¡ç† (é€£å‹•)</h4>
          <button onclick="promptAddCat()" class="btn btn-outline w-full mb-2 py-2">æ–°å¢åˆ†é¡</button>
          <div id="catList" class="max-h-60 overflow-y-auto space-y-2"></div>
        </div>
        <div class="card">
          <h4 class="font-bold mb-2 text-blue-800">ğŸ“ èªªæ˜é¸é …</h4>
          <div class="flex gap-2 mb-2"><input id="newDesc" placeholder="èªªæ˜" class="p-2 border rounded flex-1"><button id="addDescBtn" class="btn btn-primary">æ–°å¢</button></div>
          <div id="descList" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="card">
          <h4 class="font-bold mb-2 text-blue-800">ğŸ·ï¸ å‚™è¨»é¸é …</h4>
          <div class="flex gap-2 mb-2"><input id="newRem" placeholder="å‚™è¨»" class="p-2 border rounded flex-1"><button id="addRemBtn" class="btn btn-primary">æ–°å¢</button></div>
          <div id="remList" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="card col-span-1 md:col-span-2">
          <h4 class="font-bold mb-2 text-blue-800">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</h4>
          <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 mb-4 items-end bg-gray-50 p-3 rounded">
            <input id="newU" placeholder="å¸³è™Ÿ" class="border p-2 rounded" autocapitalize="none">
            <input id="newP" type="password" placeholder="å¯†ç¢¼" class="border p-2 rounded">
            <input id="newDN" placeholder="é¡¯ç¤ºåç¨±" class="border p-2 rounded">
            <select id="newRole" class="border p-2 rounded bg-white h-10"><option value="staff">å“¡å·¥</option><option value="admin">ç®¡ç†å“¡</option></select>
            <button id="addUserBtn" class="btn btn-primary w-full h-10">æ–°å¢</button>
          </div>
          <div id="userList" class="space-y-2"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<div id="modalRoot"></div>
<div id="toast">âœ… å®Œæˆ</div>

<script>
// ===============================================
// âœ… è«‹å¡«å…¥æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ (exec çµå°¾)
// ===============================================
const GAS_API_URL = "https://script.google.com/macros/s/æ‚¨çš„_GAS_DEPLOY_ID/exec"; 

let currentUser = null, dataCache = {}, SIZE_ORDER = ["S","M","L","XL","2XL","3XL","4XL","5XL","F"];
let SALES_WH_ID = "";
let allStatsData = null;
let statsFilterWh = null;
let currentSummaryTab = 'active'; 

// === Init Events ===
document.getElementById('loginBtn').onclick = doLogin;
document.querySelectorAll('.nav-item').forEach(el=>el.onclick=navClick);
document.getElementById('refreshBtn').onclick = loadAllData;
document.getElementById('searchKey').oninput = debounce(renderViews,300);
document.getElementById('filterWh').onchange = renderViews;
document.getElementById('filterCat').onchange = renderViews;
document.getElementById('logQueryBtn').onclick = fetchLogs;
document.getElementById('allStatsSearch').oninput = debounce(renderAllStatsTable, 300);
document.getElementById('exportCsvBtn').onclick = exportAllStats;
document.getElementById('addWhBtn').onclick = addWarehouseAction;
document.getElementById('addDescBtn').onclick = ()=>simpleAdd('addDesc','newDesc',loadAllData);
document.getElementById('addRemBtn').onclick = ()=>simpleAdd('addRem','newRem',loadAllData); 
document.getElementById('addUserBtn').onclick = addUser;
document.getElementById('genSizeTableBtn').onclick = genAddTable;
document.getElementById('logoutBtn').onclick = doLogout;

// === API Helper ===
async function callApi(op, data = {}) {
  try {
    const res = await fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify({ op, data })
    });
    return await res.json();
  } catch (e) {
    console.error(e);
    return { status: "error", message: "é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€ã€‚" };
  }
}

function setLoading(isLoading, text="è™•ç†ä¸­..."){
  const el = document.getElementById('loadingOverlay');
  document.getElementById('loadingText').innerText = text;
  if(isLoading) el.classList.remove('hidden'); else el.classList.add('hidden');
}

function escapeHtml(text) {
  if (text == null) return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

async function doLogin(){
  const u=document.getElementById('loginUser').value, p=document.getElementById('loginPw').value;
  setLoading(true, "ç™»å…¥ä¸­...");
  
  const res = await callApi('login', {u, p});
  setLoading(false);
  
  if(res.status==='success'){
    currentUser=res.data; 
    document.getElementById('loginScreen').classList.add('hidden'); 
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('userLabel').innerText = escapeHtml(currentUser.displayName); 
    if(currentUser.role === 'admin') document.getElementById('navSettings').classList.remove('hidden');
    else document.getElementById('navSettings').classList.add('hidden');
    loadAllData();
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('logStart').value = today;
    document.getElementById('logEnd').value = today;
  } else {
    document.getElementById('loginMsg').innerText = res.message;
  }
}

function doLogout(){
  currentUser = null; dataCache = {};
  document.getElementById('app').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('loginPw').value = "";
}

async function loadAllData(){
  setLoading(true, "è¼‰å…¥è³‡æ–™...");
  
  const ddRes = await callApi('getDropdowns');
  if(ddRes.status === 'success'){
    dataCache.dd = ddRes.data; 
    SALES_WH_ID = ddRes.data.salesWhId; 
    renderDropdowns(); 
    renderSettings();
  }

  const invRes = await callApi('getInventory');
  setLoading(false);
  if(invRes.status === 'success'){
    dataCache.summary = invRes.data; 
    renderViews();
  }
}

function switchSummaryTab(tab){
  currentSummaryTab = tab;
  document.querySelectorAll('.sub-tab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll(`.sub-tab[onclick*="${tab}"]`).forEach(el=>el.classList.add('active'));
  renderViews();
}

function renderViews(){
  if(!dataCache.summary) return;
  const rawKey = document.getElementById('searchKey').value.toLowerCase().trim();
  const keys = rawKey ? rawKey.split(/\s+/) : []; 
  const c = document.getElementById('filterCat').value;
  const wId = document.getElementById('filterWh').value;
  
  const filterFn = (list, forceShowSales=false) => list.map(w=>({
    ...w, products: w.products.filter(p=>{
       const isDisc = p.isDiscontinued;
       if(currentSummaryTab === 'active' && isDisc) return false;
       if(currentSummaryTab === 'discontinued' && !isDisc) return false;

       const searchStr = (p.name + p.color).toLowerCase();
       const matchKey = keys.length === 0 || keys.every(k => searchStr.includes(k));
       const matchCat = !c || p.category === c;
       return matchKey && matchCat;
    })
  })).filter(w => w.products.length > 0 || (forceShowSales && w.id === SALES_WH_ID));

  let normal = dataCache.summary.normal.filter(w=>w.id!==SALES_WH_ID);
  if(wId) normal = normal.filter(w=>w.id===wId);
  renderGrid(document.getElementById('summaryContainer'), filterFn(normal), false);

  let sales = dataCache.summary.normal.filter(w=>w.id===SALES_WH_ID);
  renderGrid(document.getElementById('salesContainer'), filterFn(sales, true), true);
}

function renderGrid(cont, data, isSales){
  cont.innerHTML=""; 
  if(!data.length){ cont.innerHTML='<div class="text-center text-gray-400 py-8">ç„¡è³‡æ–™</div>'; return; }
  data.forEach(wh=>{
    const d=document.createElement('div'); d.className='wh-block';
    
    const totalQty = wh.products.reduce((a,p)=>a+Object.values(p.sizes).reduce((x,y)=>x+Number(y),0),0);
    const skuCount = wh.products.length;
    
    d.innerHTML=`<div class="wh-header">
      <span class="text-lg">${escapeHtml(wh.warehouse)}</span>
      <div class="text-sm bg-blue-50 px-2 py-1 rounded text-blue-600">
        <span class="mr-2">å“é …: ${skuCount}</span>
        <span>ç¸½æ•¸: ${totalQty}</span>
      </div>
    </div>`;
    
    if(isSales && wh.products.length === 0) d.innerHTML += `<div class="p-6 text-center text-gray-400 text-sm">å°šæœªæœ‰éŠ·å”®ç´€éŒ„</div>`;
    
    wh.products.forEach(p=>{
      const r=document.createElement('div'); r.className='prod-row';
      const priceTag = p.price ? `<span class="text-sm text-gray-500 font-normal ml-1">($${p.price})</span>` : '';
      
      r.innerHTML=`<div>
        <div class="font-bold text-xl text-blue-900 mb-1 leading-tight">${escapeHtml(p.name)} ${priceTag}</div>
        <div class="text-base text-gray-600 mb-3 flex items-center gap-2">
           <span class="bg-gray-100 px-2 py-0.5 rounded text-xs">${escapeHtml(p.category)}</span>
           <span>${escapeHtml(p.color)}</span>
        </div>
        ${!isSales?renderDescSel(p.id,p.description):''}
      </div>`;
      
      const sg=document.createElement('div'); sg.className='size-grid';
      Object.keys(p.sizes).sort((a,b)=>SIZE_ORDER.indexOf(a)-SIZE_ORDER.indexOf(b)).forEach(s=>{
        const q=p.sizes[s];
        const rem = p.remarks[s] || "";
        const inputId = `qty_${wh.id}_${p.id}_${s}`;
        
        let h = `<div class="size-box"><div class="text-sm text-gray-500 font-bold">${escapeHtml(s)}</div>`;
        
        if(isSales) {
          h+=`<div id="${inputId}" class="font-bold text-2xl text-blue-600 py-2">${q}</div></div>`;
        } else {
          h+=`<input id="${inputId}" type="number" inputmode="numeric" min="0" class="qty-input ${q>0?'qty-positive':''}" value="${q}" onchange="updQty('${wh.id}','${p.id}','${s}',this)">`;
          h+=`<div class="flex justify-center gap-1 mt-1 action-btn-group">
                <button class="flex-1 border rounded hover:bg-gray-100 active:bg-gray-200" onclick="openTrans('${wh.id}','${escapeHtml(wh.warehouse)}','${p.id}','${escapeHtml(p.name)}','${s}',${q})">â‡„</button>
                <button class="flex-1 border border-amber-200 text-amber-600 rounded hover:bg-amber-50 active:bg-amber-100" onclick="doSell('${wh.id}','${p.id}','${s}',this)">ğŸ’²</button>
              </div>`;
          h+=`<select class="remark-select mt-1" onchange="updRemark('${wh.id}','${p.id}','${s}',this.value)">
                <option value="">-</option>
                ${dataCache.dd.remarks.map(x=>`<option value="${escapeHtml(x)}" ${x===rem?'selected':''}>${escapeHtml(x)}</option>`).join('')}
              </select>`;
          h+=`</div>`;
        }
        sg.innerHTML+=h;
      });
      r.appendChild(sg); d.appendChild(r);
    });
    cont.appendChild(d);
  });
}

function updateLocalState(wid, pid, size, delta) {
  if (dataCache && dataCache.summary) {
    const wh = dataCache.summary.normal.find(w => w.id === wid);
    if (wh) {
      const p = wh.products.find(x => x.id === pid);
      if (p) {
        if (p.sizes[size] === undefined) p.sizes[size] = 0;
        p.sizes[size] = Number(p.sizes[size]) + delta;
      }
    }
  }

  const elId = `qty_${wid}_${pid}_${size}`;
  const el = document.getElementById(elId);
  if (el) {
    const currentVal = Number(el.value || el.innerText || 0);
    const newVal = currentVal + delta;
    if (el.tagName === 'INPUT') {
      el.value = newVal;
      if (newVal > 0) el.classList.add('qty-positive');
      else el.classList.remove('qty-positive');
      el.classList.add('qty-saved');
      setTimeout(() => el.classList.remove('qty-saved'), 1000);
    } else {
      el.innerText = newVal;
    }
  }
}

async function updQty(wid,pid,s,el){
  const v=Number(el.value); 
  if (v < 0) { alert("æ•¸é‡ä¸èƒ½ç‚ºè² "); el.value = 0; return; }
  el.classList.remove('qty-saved', 'qty-error'); el.classList.add('qty-saving');
  if(v>0) el.classList.add('qty-positive'); else el.classList.remove('qty-positive');
  
  const res = await callApi('updateQty', {warehouseId:wid, productId:pid, size:s, value:v, operator:currentUser.displayName});
  el.classList.remove('qty-saving');
  
  if(res.status==='success') {
    el.classList.add('qty-saved'); setTimeout(()=>el.classList.remove('qty-saved'), 2000);
  } else {
    el.classList.add('qty-error'); alert(res.message); 
  }
}

async function updRemark(wid,pid,s,val){
  const res = await callApi('updateRemark', {warehouseId:wid, productId:pid, size:s, remark:val});
  if(res.status!=='success') alert(res.message);
}

async function doSell(wid,pid,s,btn){
  const container = btn.closest('.size-box'); 
  const inp = container.querySelector('input');
  let currentStock = Number(inp.value); 
  if(currentStock <= 0) return alert('ç„¡åº«å­˜');
  const qtyStr = prompt(`éŠ·å”® ${s}\nç›®å‰åº«å­˜: ${currentStock}\nè«‹è¼¸å…¥éŠ·å”®æ•¸é‡:`, "1");
  if(qtyStr === null) return;
  const qty = Number(qtyStr);
  if(isNaN(qty) || qty <= 0) return alert("æ•¸é‡è¼¸å…¥éŒ¯èª¤");
  if(qty > currentStock) return alert("åº«å­˜ä¸è¶³");

  setLoading(true, "éŠ·å”®ä¸­...");
  const res = await callApi('sellItem', {fromWh:wid, productId:pid, size:s, qty:qty, operator:currentUser.displayName});
  
  setLoading(false);
  if(res.status==='success'){ 
    showToast(`å·²éŠ·å”® ${qty} ä»¶`); 
    updateLocalState(wid, pid, s, -qty); 
    updateLocalState(SALES_WH_ID, pid, s, qty); 
  } 
  else { alert(res.message); inp.value=currentStock; } 
}

function renderDescSel(pid,val){ return `<select class="text-sm border rounded mt-1 bg-white w-full max-w-[200px] p-2" onchange="updDesc('${pid}',this.value)"><option value="">(ç„¡èªªæ˜)</option>${dataCache.dd.descriptions.map(d=>`<option value="${escapeHtml(d)}" ${d===val?'selected':''}>${escapeHtml(d)}</option>`).join('')}</select>`; }
async function updDesc(pid,v){ await callApi('updateDesc', {productId:pid, value:v}); }

async function fetchLogs(){
  const s = document.getElementById('logStart').value;
  const e = document.getElementById('logEnd').value;
  const w = document.getElementById('logWhFilter').value;
  const t = document.getElementById('logTypeFilter').value;
  if(!s || !e) return alert("è«‹é¸æ“‡æ—¥æœŸå€é–“");
  setLoading(true, "æŸ¥è©¢ä¸­...");
  const res = await callApi('getLogs', {startDate:s, endDate:e, warehouseId:w, type:t});
  setLoading(false);
  if(res.status === 'success') renderLogs(res.data); else alert(res.message);
}

function renderLogs(rows){
  document.getElementById('logThead').innerHTML='<tr><th>æ™‚é–“</th><th>å•†å“</th><th>ä¾†æº</th><th>ç›®æ¨™</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr>';
  if(!rows.length){ document.getElementById('logTbody').innerHTML='<tr><td colspan="6" class="text-center text-gray-400 p-4">ç„¡è³‡æ–™</td></tr>'; return; }
  document.getElementById('logTbody').innerHTML=rows.map(r=>`<tr><td>${r.time}</td><td>${escapeHtml(r.product)}</td><td>${escapeHtml(r.from)}</td><td>${escapeHtml(r.to)}</td><td>${r.qty}</td><td>${escapeHtml(r.operator)}</td></tr>`).join('');
}

async function simpleAdd(fn,id,cb){ 
  const v=document.getElementById(id).value; if(!v)return; 
  setLoading(true); 
  await callApi(fn, v);
  setLoading(false);
  cb(); 
  document.getElementById(id).value=""; 
}

async function addWarehouseAction(){
  const n = document.getElementById('newWhName').value;
  const l = document.getElementById('newWhLoc').value;
  if(!n) return alert("è«‹è¼¸å…¥å€‰åº«åç¨±");
  setLoading(true, "å»ºç«‹å€‰åº«(å«åº«å­˜åˆå§‹åŒ–)...");
  await callApi('addWh', {name: n, location: l});
  setLoading(false);
  document.getElementById('newWhName').value = "";
  document.getElementById('newWhLoc').value = "";
  loadAllData();
}

async function addUser(){ 
  const u=document.getElementById('newU').value, p=document.getElementById('newP').value, dn=document.getElementById('newDN').value, r=document.getElementById('newRole').value; 
  if(!u||!p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); 
  setLoading(true); 
  const res = await callApi('addUser', {username:u, password:p, displayName:dn, role:r});
  setLoading(false);
  if(res.status==='error') return alert(res.message);
  document.getElementById('newU').value=""; document.getElementById('newP').value=""; document.getElementById('newDN').value=""; renderSettings(); 
}

async function promptAddCat(){ 
  const n=prompt("åç¨±"); if(!n)return; 
  const s=prompt("å°ºå¯¸ (é€—è™Ÿåˆ†éš”)"); if(s!==null){ 
    setLoading(true); 
    await callApi('addCat', {n, s});
    setLoading(false);
    loadAllData();
  }
}

function renderDropdowns(){
  const d=dataCache.dd;
  const whOpts = '<option value="">ä¸é™å€‰åº«</option>' + d.warehouses.filter(w=>w.id!==SALES_WH_ID).map(w=>`<option value="${w.id}">${escapeHtml(w.name)}</option>`).join('');
  document.getElementById('filterWh').innerHTML=whOpts.replace("ä¸é™å€‰åº«","å…¨éƒ¨å€‰åº«");
  document.getElementById('logWhFilter').innerHTML=whOpts;
  document.getElementById('filterCat').innerHTML='<option value="">å…¨éƒ¨åˆ†é¡</option>'+Object.keys(d.categories).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  document.getElementById('addCatSelect').innerHTML=Object.keys(d.categories).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  document.getElementById('addDescSelect').innerHTML=d.descriptions.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('');
}

async function renderSettings(){
  const d=dataCache.dd;
  document.getElementById('whList').innerHTML = d.warehouses.filter(w => w.id !== SALES_WH_ID).map(w => `<div class="flex justify-between p-3 bg-gray-50 border rounded-lg text-sm items-center"><span>${escapeHtml(w.name)} <span class="text-xs text-gray-400 block">(${escapeHtml(w.location||'ç„¡åœ°é»')})</span></span><div class="flex gap-3"><button onclick="editWh('${w.id}','${escapeHtml(w.name)}')" class="text-blue-500 p-1">âœï¸</button><button onclick="delObj('deleteWh','${w.id}',loadAllData)" class="text-red-500 p-1">âœ•</button></div></div>`).join('');
  document.getElementById('catList').innerHTML=Object.keys(d.categories).map(c=>`<div class="flex justify-between p-3 border-b text-sm items-center"><div><span class="font-bold text-base block mb-1">${escapeHtml(c)}</span> <span class="text-xs text-gray-500 break-all">(${d.categories[c].map(escapeHtml).join(',')})</span></div><div class="flex gap-3 ml-2 shrink-0"><button onclick="editCat('${escapeHtml(c)}','${d.categories[c]}')" class="text-blue-500 p-1">âœï¸</button><button onclick="delObj('deleteCat','${c}',loadAllData)" class="text-red-500 p-1">âœ•</button></div></div>`).join('');
  document.getElementById('descList').innerHTML=d.descriptions.map(c=>`<span class="bg-gray-100 px-3 py-1.5 rounded-full text-sm flex items-center gap-2 m-1">${escapeHtml(c)}<button onclick="editDesc('${escapeHtml(c)}')" class="text-blue-500">âœï¸</button><button onclick="delObj('deleteDesc','${c}',loadAllData)" class="text-red-500 font-bold">Ã—</button></span>`).join('');
  document.getElementById('remList').innerHTML=d.remarks.map(c=>`<span class="bg-gray-100 px-3 py-1.5 rounded-full text-sm flex items-center gap-2 m-1">${escapeHtml(c)}<button onclick="delObj('deleteRem','${c}',loadAllData)" class="text-red-500 font-bold">Ã—</button></span>`).join('');
  
  const userRes = await callApi('getUsers');
  if(userRes.status==='success'){
    const u = userRes.data;
    document.getElementById('userList').innerHTML=u.map(x=>`<div class="flex justify-between text-sm border-b p-3 items-center"><div><span class="font-bold block">${escapeHtml(x.displayName)}</span><span class="text-gray-400 text-xs">${x.username} / ${x.role}</span></div><div class="flex gap-3"><button onclick="editUser('${x.username}')" class="text-blue-500 p-1">âœï¸</button>${x.username!=='admin' ? `<button onclick="delObj('deleteUser','${x.username}',renderSettings)" class="text-red-500 p-1">âœ•</button>` : ''}</div></div>`).join('');
  }
}

async function editWh(id,old){ const n=prompt("ä¿®æ”¹åç¨±",old); if(n&&n!==old){ setLoading(true); await callApi('updateWh', {id,name:n}); setLoading(false); loadAllData(); } }
async function editCat(old,sz){ const n=prompt("ä¿®æ”¹åˆ†é¡",old); if(!n)return; const s=prompt("ä¿®æ”¹å°ºå¯¸",sz); if(s!==null){ setLoading(true); await callApi('updateCat', {oldName:old,newName:n,sizes:s}); setLoading(false); loadAllData(); } }
async function editDesc(old){ const n=prompt("ä¿®æ”¹",old); if(n&&n!==old){ setLoading(true); await callApi('updateDesc', {oldVal:old,newVal:n}); setLoading(false); loadAllData(); } }
async function editUser(u){ const p=prompt("é‡è¨­å¯†ç¢¼(ç•™ç©ºä¸æ”¹)"); if(p){ setLoading(true); await callApi('updateUser', {username:u,password:p}); setLoading(false); alert("å·²ä¿®æ”¹"); } }
async function delObj(fn,id,cb){ if(confirm("ç¢ºå®šåˆªé™¤?")){ setLoading(true); const res = await callApi(fn, fn.includes('Wh')?{id}:id); setLoading(false); if(res&&res.status==='error') alert(res.message); else cb(); } }

function genAddTable(){
  const c=document.getElementById('addCatSelect').value; if(!c)return;
  const sizes=dataCache.dd.categories[c]; const whs=dataCache.dd.warehouses.filter(w=>w.id!==SALES_WH_ID);
  let h='<table class="w-full text-sm text-center mb-4 min-w-[500px]"><thead><tr><th></th>'+sizes.map(s=>`<th>${s}</th>`).join('')+'</tr></thead><tbody>';
  whs.forEach(w=>{h+=`<tr><td class="text-left font-bold py-2 whitespace-nowrap px-2">${escapeHtml(w.name)}</td>`+sizes.map(s=>`<td><input type="number" inputmode="numeric" min="0" data-w="${w.id}" data-s="${s}" class="w-12 border p-1 rounded text-center new-qty" placeholder="0"></td>`).join('')+`</tr>`;});
  document.getElementById('addSizeTable').innerHTML=h+'</tbody></table><button onclick="subProd()" class="btn btn-primary w-full py-3">ç¢ºèªæ–°å¢</button>';
  document.getElementById('addSizeTable').classList.remove('hidden');
}

async function subProd(){
  const n=document.getElementById('addName').value, pr=document.getElementById('addPrice').value, c=document.getElementById('addCatSelect').value; 
  if(!n.trim()||pr==="") return alert("è«‹è¼¸å…¥åç¨±èˆ‡åƒ¹æ ¼");
  const list = dataCache.dd.categories[c].map(s=>{ const qMap = []; document.querySelectorAll(`.new-qty[data-s="${s}"]`).forEach(i=>{if(i.value>0)qMap.push({warehouseId:i.dataset.w, qty:i.value})}); return {size:s, qtyMap:qMap}; });
  setLoading(true, "å»ºç«‹å•†å“...");
  const res = await callApi('addProduct', {name:n,cat:c,color:document.getElementById('addColor').value,price:pr,description:document.getElementById('addDescSelect').value,sizeList:list});
  setLoading(false);
  showToast(res.message); 
  loadAllData(); 
  document.querySelector('[data-target="summarySection"]').click(); 
  document.getElementById('addName').value=""; document.getElementById('addPrice').value=""; document.getElementById('addSizeTable').classList.add('hidden'); 
}

function renderAllStatsTable(){
  if(!allStatsData) return;
  let summaryHTML = `<div class="stats-grid"><div class="stat-card cursor-pointer hover:bg-blue-100 ${statsFilterWh===null ? 'bg-blue-100 border-blue-400 ring-2 ring-blue-400' : 'bg-blue-50 border-blue-200'}" onclick="setStatsFilter(null)"><div class="text-sm text-gray-500">å…¨éƒ¨ç¸½åº«å­˜</div><div class="text-2xl font-bold text-blue-700">${allStatsData.grandTotal}</div></div>`;
  allStatsData.whStats.forEach(w => { const isActive = statsFilterWh === w.id; summaryHTML += `<div class="stat-card cursor-pointer hover:bg-gray-100 transition ${isActive ? 'bg-white ring-2 ring-blue-500 border-transparent' : ''}" onclick="setStatsFilter('${w.id}')"><div class="text-sm text-gray-500">${escapeHtml(w.name)}</div><div class="text-xl font-bold">${w.totalQty}</div></div>`; });
  summaryHTML += `</div>`;
  document.getElementById('allStatsSummary').innerHTML = summaryHTML;
  const rawKey = document.getElementById('allStatsSearch').value.toLowerCase().trim();
  const keys = rawKey ? rawKey.split(/\s+/) : []; 
  const rows = allStatsData.rows.filter(r => { const s = (r.name + r.color).toLowerCase(); return keys.length === 0 || keys.every(k => s.includes(k)); });
  if(!rows.length){ document.getElementById('allStatsContainer').innerHTML = '<div class="text-center py-4 text-gray-400">ç„¡è³‡æ–™</div>'; return; }
  let h = `<div class="table-container"><table class="data-table sticky-head"><thead><tr><th>å•†å“åç¨±</th><th>é¡è‰²</th><th>å”®åƒ¹</th>`+allStatsData.headers.map(s=>`<th class="text-center">${s}</th>`).join('')+`<th class="text-right">åˆè¨ˆ</th></tr></thead><tbody>`;
  rows.forEach(r => { const dataSrc = statsFilterWh ? (r.whData[statsFilterWh] || {}) : r.sizes; let rowTotal = 0; if(statsFilterWh) { rowTotal = Object.values(dataSrc).reduce((a,b)=>a+Number(b),0); } else { rowTotal = r.total; } h += `<tr><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.color||'')}</td><td>${r.price||''}</td>`+allStatsData.headers.map(s=>{const q = dataSrc[s] || 0; return `<td class="text-center ${q>0?'font-bold text-green-600':'text-gray-300'}">${q}</td>`; }).join('')+`<td class="text-right font-bold">${rowTotal}</td></tr>`; });
  document.getElementById('allStatsContainer').innerHTML = h+`</tbody></table></div>`;
}

function setStatsFilter(wid){ statsFilterWh = wid; renderAllStatsTable(); }

function exportAllStats(){ 
  if(!allStatsData||!allStatsData.rows.length)return alert("ç„¡è³‡æ–™"); 
  const headers = ["å•†å“åç¨±","é¡è‰²","å”®åƒ¹",...allStatsData.headers,"åˆè¨ˆ"];
  const rows = allStatsData.rows.map(r => { const dataSrc = statsFilterWh ? (r.whData[statsFilterWh] || {}) : r.sizes; const rowTotal = statsFilterWh ? Object.values(dataSrc).reduce((a,b)=>a+Number(b),0) : r.total; return [`"${r.name}"`, `"${r.color||''}"`, r.price||0,...allStatsData.headers.map(s=>dataSrc[s]||0),rowTotal].join(","); });
  const csv = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n"); 
  const prefix = statsFilterWh ? (allStatsData.whStats.find(w=>w.id===statsFilterWh)?.name || "å€‰åº«") : "å…¨å€‰";
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`${prefix}çµ±è¨ˆ_${new Date().toISOString().slice(0,10)}.csv`; a.click(); 
}

function openTrans(wid,wn,pid,pn,s,max){ const others = dataCache.dd.warehouses.filter(w=>w.id!==wid && w.id!==SALES_WH_ID); if(!others.length)return alert('ç„¡å…¶ä»–å€‰åº«'); document.getElementById('modalRoot').innerHTML=`<div class="modal-overlay"><div class="modal-box"><h3 class="font-bold mb-4 text-xl">èª¿æ’¥åº«å­˜</h3><div class="mb-4 bg-gray-50 p-3 rounded text-sm"><p class="font-bold text-blue-800">${escapeHtml(pn)} (${s})</p><p class="text-gray-500">ä¾†æº: ${escapeHtml(wn)}</p></div><label class="block mb-4 text-sm font-medium">ç›®æ¨™å€‰åº« <select id="toW" class="border p-2 w-full rounded mt-1 bg-white h-10">${others.map(w=>`<option value="${w.id}">${escapeHtml(w.name)}</option>`).join('')}</select></label><label class="block mb-6 text-sm font-medium">æ•¸é‡ <input id="tQ" type="number" inputmode="numeric" value="1" max="${max}" min="1" class="border p-2 w-full rounded mt-1 h-10 text-center font-bold text-lg"></label><div class="flex justify-end gap-3"><button class="btn btn-ghost px-4" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary px-6 py-2" onclick="doTrans('${wid}','${pid}','${s}')">ç¢ºå®šèª¿æ’¥</button></div></div></div>`; }

async function doTrans(fid,pid,s){ 
  const tid=document.getElementById('toW').value;
  const qtyInput = document.getElementById('tQ');
  const qty=Number(qtyInput.value); 
  const maxQty = Number(qtyInput.getAttribute('max'));

  if(qty <= 0) return alert("èª¿æ’¥æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
  if(qty > maxQty) return alert(`åº«å­˜ä¸è¶³ (æœ€å¤§å¯èª¿æ’¥: ${maxQty})`);
  if(fid === tid) return alert("ä¾†æºèˆ‡ç›®æ¨™å€‰åº«ä¸èƒ½ç›¸åŒ");

  closeModal(); 
  setLoading(true,"èª¿æ’¥ä¸­..."); 
  const res = await callApi('transfer', {from:fid, to:tid, productId:pid, size:s, qty:qty, operator:currentUser.displayName});
  setLoading(false); 
  if(res.status==='success'){ 
    showToast('èª¿æ’¥å®Œæˆ'); 
    updateLocalState(fid, pid, s, -qty); 
    updateLocalState(tid, pid, s, qty);  
  } else { alert(res.message); }
}

function closeModal(){ document.getElementById('modalRoot').innerHTML=""; }
function navClick(e){ document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('section').forEach(x=>x.classList.add('hidden')); document.getElementById(e.target.dataset.target).classList.remove('hidden'); const t = e.target.dataset.target; if(t === 'allStatsSection'){ setLoading(true); google.script.run.withSuccessHandler(res=>{ setLoading(false); allStatsData=res.data; renderAllStatsTable(); }).getAllWarehouseSummary(); } if(t === 'logSection') fetchLogs(); }
function debounce(f,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),ms)}}
function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

// Fix for navClick when calling API directly (removing google.script.run logic inside navClick)
async function navClick(e){ 
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); 
  e.target.classList.add('active'); 
  document.querySelectorAll('section').forEach(x=>x.classList.add('hidden')); 
  document.getElementById(e.target.dataset.target).classList.remove('hidden'); 
  const t = e.target.dataset.target; 
  if(t === 'allStatsSection'){ 
    setLoading(true); 
    const res = await callApi('getAllStats');
    setLoading(false); 
    allStatsData=res.data; 
    renderAllStatsTable(); 
  } 
  if(t === 'logSection') fetchLogs(); 
}
</script>
</body>
</html>