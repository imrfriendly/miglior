<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#667eea">
<title>MIGLIOR X ForrHer</title>

<style>
/* CSS ‰øùÊåÅÂéüÊ®£ÔºåÂÆåÂÖ®‰∏çÈúÄË¶ÅÊõ¥ÂãïÔºåÁõ¥Êé•Ë§áË£ΩÂéüÊú¨ÁöÑÂç≥ÂèØ */
:root {
  --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --glass-surface: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-highlight: rgba(255, 255, 255, 0.5);
  --neon-glow: 0 0 10px rgba(118, 220, 255, 0.8), 0 0 20px rgba(118, 220, 255, 0.4);
  --text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

html, body {
  margin: 0; padding: 0; width: 100%; height: 100dvh;
  background: var(--bg-gradient);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
  overflow: hidden; user-select: none; -webkit-user-select: none;
  -webkit-tap-highlight-color: transparent; overscroll-behavior: none; 
}

/* ================= 1. Ê•µËá¥ÁôªÂÖ•È†Å (Future Glass) ================= */
#loginContainer {
  height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 2000; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg-gradient); backdrop-filter: blur(10px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.lock-icon {
  font-size: 60px; margin-bottom: 20px;
  filter: drop-shadow(0 0 15px rgba(255,255,255,0.4));
  animation: float 3s ease-in-out infinite;
}
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

.login-title {
  color: white; font-size: 20px; font-weight: 500; margin-bottom: 40px;
  letter-spacing: 2px; opacity: 0.9; text-transform: uppercase;
}

.passcode-dots { display: flex; gap: 30px; margin-bottom: 70px; height: 20px; }
.dot {
  width: 14px; height: 14px; border-radius: 50%;
  background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
  transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.dot.filled { background: #fff; box-shadow: var(--neon-glow); transform: scale(1.3); border-color: transparent; }
.dot.error { background: #ff4757; box-shadow: 0 0 15px #ff4757; animation: shake 0.4s; }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } }

.keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px 40px; }
.key {
  width: 75px; height: 75px; border-radius: 50%;
  background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
  display: flex; justify-content: center; align-items: center;
  font-size: 32px; color: white; font-weight: 300; cursor: pointer;
  transition: all 0.15s; position: relative; overflow: hidden;
}
.key.active-state {
  background: rgba(255, 255, 255, 0.25); box-shadow: 0 0 20px rgba(255,255,255,0.2);
  transform: scale(0.92); border-color: rgba(255,255,255,0.5);
}

/* ================= 2. ‰∏ªÈ†ÅÈù¢ (App Grid) ================= */
#mainContainer {
  display: none; height: 100%; flex-direction: column;
  padding: calc(env(safe-area-inset-top) + 30px) 25px 0 25px; box-sizing: border-box;
  animation: zoomIn 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}
@keyframes zoomIn { from { opacity: 0; transform: scale(1.1); filter: blur(10px); } to { opacity: 1; transform: scale(1); filter: blur(0); } }

.header {
  color: white; font-size: 34px; font-weight: 800; margin-bottom: 30px;
  padding-left: 5px; letter-spacing: 1px; text-shadow: 0 4px 10px rgba(0,0,0,0.2);
  display: flex; align-items: center; justify-content: space-between;
}
.header span { font-size: 14px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-weight: 600; backdrop-filter: blur(5px); }

.app-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px 25px;
  overflow-y: auto; padding-bottom: 120px; padding-top: 10px; scrollbar-width: none; 
}
.app-grid::-webkit-scrollbar { display: none; }

.app-item { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; -webkit-touch-callout: none; }

.app-icon-box {
  width: 130px; height: 130px;
  background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-radius: 32px; display: flex; align-items: center; justify-content: center;
  font-size: 64px; box-shadow: inset 0 1px 1px rgba(255,255,255,0.6), inset 0 -1px 1px rgba(0,0,0,0.1), 0 15px 35px rgba(0,0,0,0.2);
  border: 1px solid rgba(255, 255, 255, 0.25); transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative; overflow: hidden;
}
.app-icon-box::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
  background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 100%);
  border-radius: 32px 32px 0 0; pointer-events: none;
}
.app-item:active .app-icon-box { transform: scale(0.92) translateY(2px); filter: brightness(0.9); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }

.app-name {
  margin-top: 15px; font-size: 15px; font-weight: 600; color: white;
  text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.4);
  width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 5px; opacity: 0.95;
}

.loading { grid-column: 1 / -1; text-align: center; color: white; font-size: 16px; margin-top: 80px; font-weight: 500; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }

.add-btn {
  width: 64px; height: 64px; background: rgba(255, 255, 255, 0.9); border-radius: 50%;
  position: fixed; bottom: calc(40px + env(safe-area-inset-bottom)); right: 30px;
  display: flex; align-items: center; justify-content: center; font-size: 36px; color: #667eea;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; cursor: pointer;
  transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); backdrop-filter: blur(10px);
}
.add-btn:active { transform: scale(0.85) rotate(90deg); }

.overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6);
  z-index: 3000; display: none; opacity: 0; transition: opacity 0.25s; backdrop-filter: blur(8px);
}
.action-sheet {
  position: absolute; bottom: 30px; left: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px;
  transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
}
.action-group {
  background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(30px);
  border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.action-btn {
  width: 100%; padding: 20px; background: transparent; border: none;
  border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 18px; color: #007AFF; cursor: pointer; font-weight: 500;
}
.action-btn:last-child { border-bottom: none; }
.action-btn:active { background: rgba(0,0,0,0.05); }
.action-btn.danger { color: #FF3B30; }
.cancel-btn {
  background: white; border-radius: 20px; color: #007AFF; font-weight: 700;
  padding: 20px; border: none; font-size: 18px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}

.input-dialog {
  position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
  width: 85%; max-width: 320px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(40px);
  border-radius: 28px; padding: 28px; box-shadow: 0 25px 80px rgba(0,0,0,0.5);
  display: none; flex-direction: column; gap: 18px; opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.dialog-title { text-align: center; font-weight: 800; font-size: 22px; color: #333; }
.dialog-input {
  width: 100%; box-sizing: border-box; padding: 16px; border: 2px solid #eee;
  border-radius: 16px; background: #f9f9f9; font-size: 17px; transition: border-color 0.2s;
}
.dialog-input:focus { outline: none; border-color: #667eea; background: white; }
.dialog-buttons { display: flex; gap: 15px; margin-top: 10px; }
.dialog-btn { flex: 1; padding: 16px; border: none; border-radius: 16px; font-size: 17px; font-weight: 700; cursor: pointer; }
.btn-cancel { background: #f0f0f5; color: #8e8e93; }
.btn-confirm { background: #667eea; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
</style>
</head>

<body oncontextmenu="return false;">

<div id="loginContainer">
  <div class="lock-icon">üîê</div>
  <div class="login-title">Security Access</div>
  <div class="passcode-dots">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
  <div class="keypad" id="keypad">
    <div class="key" data-key="1">1</div><div class="key" data-key="2">2</div><div class="key" data-key="3">3</div>
    <div class="key" data-key="4">4</div><div class="key" data-key="5">5</div><div class="key" data-key="6">6</div>
    <div class="key" data-key="7">7</div><div class="key" data-key="8">8</div><div class="key" data-key="9">9</div>
    <div class="key" style="cursor:default; background:transparent; border:none; pointer-events:none;"></div>
    <div class="key" data-key="0">0</div>
    <div class="key key-delete" data-key="del">‚å´</div>
  </div>
</div>

<div id="mainContainer">
  <div class="header">
    <div>ÁæéÂÆ¢È∫óÁàæ</div>
    <span>V2.0</span>
  </div>
  <div class="app-grid" id="appList">
    <div class="loading">Á≥ªÁµ±ÈÄ£Á∑ö‰∏≠...</div>
  </div>
</div>

<div class="add-btn" onclick="openAdd()">+</div>

<div class="overlay" id="actionOverlay" onclick="closeActionSheet()">
  <div class="action-sheet" id="actionSheet">
    <div class="action-group">
      <button class="action-btn" id="btnEdit">Á∑®ËºØ App</button>
      <button class="action-btn danger" id="btnDelete">Âà™Èô§ App</button>
    </div>
    <button class="action-btn cancel-btn" onclick="closeActionSheet()">ÂèñÊ∂à</button>
  </div>
</div>

<div class="overlay" id="inputOverlay" style="z-index: 3100;">
  <div class="input-dialog" id="inputDialog">
    <div class="dialog-title" id="dialogTitle">App Ë®≠ÂÆö</div>
    <input type="text" class="dialog-input" id="inpName" placeholder="App ÂêçÁ®±">
    <input type="url" class="dialog-input" id="inpUrl" placeholder="Á∂≤ÂùÄ (https://...)">
    <input type="text" class="dialog-input" id="inpEmoji" placeholder="Emoji (‰æãÂ¶Ç: üìå)">
    <div class="dialog-buttons">
      <button class="dialog-btn btn-cancel" onclick="closeInputDialog()">ÂèñÊ∂à</button>
      <button class="dialog-btn btn-confirm" id="btnDialogConfirm">Á¢∫ÂÆö</button>
    </div>
  </div>
</div>

<script>
// ===============================================
// ‚úÖ ÂøÖÈ†àË®≠ÂÆöÔºöË´ãÂ°´ÂÖ•ÊÇ®ÁöÑ GAS ÈÉ®ÁΩ≤Á∂≤ÂùÄ (exec ÁµêÂ∞æ)
// ===============================================
const GAS_API_URL = "https://script.google.com/macros/s/AKfycby39B4DzQyocfj85jkvpS1V9a9AGbsv9Bx7Coq8dl845DfGoNbsuAwHRgVccHz6vqzyDg/exec"; 

// --- ÂèÉÊï∏Ë®≠ÂÆö ---
const CORRECT_PASS = "0625";
let currentInput = "";
let isProcessing = false;

// --- ÁôªÂÖ•ÈÇèËºØ ---
(function initKeypad() {
  const keys = document.querySelectorAll('.key[data-key]');
  keys.forEach(key => {
    key.addEventListener('touchstart', (e) => {
      e.preventDefault(); if (isProcessing) return;
      key.classList.add('active-state');
      if(navigator.vibrate) navigator.vibrate(5);
      handleInput(key.getAttribute('data-key'));
    }, { passive: false });
    key.addEventListener('touchend', () => key.classList.remove('active-state'));
    key.addEventListener('mousedown', () => {
       key.classList.add('active-state'); handleInput(key.getAttribute('data-key'));
    });
    const clearState = () => key.classList.remove('active-state');
    key.addEventListener('mouseup', clearState);
    key.addEventListener('mouseleave', clearState);
  });
})();

function handleInput(num) {
  const dots = document.querySelectorAll(".dot");
  if (num === 'del') currentInput = currentInput.slice(0, -1);
  else if (currentInput.length < 4) currentInput += num;
  updateDots(dots);

  if (currentInput.length === 4) {
    isProcessing = true;
    setTimeout(() => {
      if (currentInput === CORRECT_PASS) {
        document.getElementById("loginContainer").style.transform = "scale(1.1)";
        document.getElementById("loginContainer").style.opacity = "0";
        setTimeout(() => {
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("mainContainer").style.display = "flex";
          loadApps(); // ÁôªÂÖ•ÊàêÂäüÂæåËºâÂÖ•Ë≥áÊñô
        }, 500);
      } else {
        dots.forEach(dot => dot.classList.add("error"));
        if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
        setTimeout(() => {
          currentInput = ""; updateDots(dots);
          dots.forEach(dot => dot.classList.remove("error"));
          isProcessing = false;
        }, 500);
      }
    }, 100);
  }
}

function updateDots(dots) {
  dots.forEach((dot, idx) => {
    if (idx < currentInput.length) dot.classList.add("filled");
    else dot.classList.remove("filled", "error");
  });
}

// --- API Ê∫ùÈÄöÊ†∏ÂøÉ (fetch Âèñ‰ª£ google.script.run) ---
async function callApi(op, data = {}) {
  // Â¶ÇÊûúÊòØËÆÄÂèñÔºåÁî® GET Â∏∂ÂèÉÊï∏
  if (op === 'read') {
    try {
      const res = await fetch(`${GAS_API_URL}?op=read`);
      return await res.json();
    } catch (e) {
      console.error(e);
      return [];
    }
  } 
  // Â¶ÇÊûúÊòØÂØ´ÂÖ•ÔºåÁî® POST
  else {
    try {
      const payload = { op: op, ...data };
      const res = await fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      return await res.json();
    } catch (e) {
      alert("ÈÄ£Á∑öÂ§±ÊïóÔºö" + e);
      return { status: 'error' };
    }
  }
}

// --- App ËÆÄÂèñ ---
function loadApps() {
  callApi('read').then(list => renderApps(list));
}

function renderApps(list) {
  const div = document.getElementById("appList");
  div.innerHTML = "";
  if (!list || list.length === 0) {
    div.innerHTML = "<div class='loading' style='color:#fff'>ÈªûÊìäÂè≥‰∏ãËßí + Êñ∞Â¢û</div>";
    return;
  }
  list.forEach((app) => {
    const el = document.createElement("div");
    el.className = "app-item";
    el.innerHTML = `
      <div class="app-icon-box">${app.emoji}</div>
      <div class="app-name">${app.name}</div>
    `;
    setupAppInteraction(el, app, app.rowIndex);
    div.appendChild(el);
  });
}

function setupAppInteraction(element, appData, rowIndex) {
  let timer = null; let startY = 0; let isDragging = false; let longPressTriggered = false;

  element.addEventListener("touchstart", (e) => {
    isDragging = false; longPressTriggered = false; startY = e.touches[0].clientY;
    element.querySelector('.app-icon-box').style.transform = "scale(0.92)";
    timer = setTimeout(() => {
      longPressTriggered = true; if(navigator.vibrate) navigator.vibrate(50);
      element.querySelector('.app-icon-box').style.transform = "scale(1)";
      showActionSheet(rowIndex, appData);
    }, 600); 
  }, {passive: false});

  element.addEventListener("touchmove", (e) => {
    if (Math.abs(e.touches[0].clientY - startY) > 10) {
      isDragging = true; if (timer) { clearTimeout(timer); timer = null; }
      element.querySelector('.app-icon-box').style.transform = "scale(1)";
    }
  });

  element.addEventListener("touchend", (e) => {
    element.querySelector('.app-icon-box').style.transform = "scale(1)";
    if (timer) { clearTimeout(timer); timer = null; }
    if (longPressTriggered || isDragging) return;
    if (e.cancelable) e.preventDefault();
    if(document.getElementById("actionOverlay").style.display === "block") return;
    openApp(appData.url);
  });

  element.addEventListener("mousedown", () => {
    timer = setTimeout(() => {
      longPressTriggered = true; showActionSheet(rowIndex, appData);
    }, 600);
  });
  
  element.addEventListener("click", () => {
    if (timer) clearTimeout(timer);
    if (!longPressTriggered) openApp(appData.url);
    longPressTriggered = false;
  });
}

function openApp(url) { window.open(url, "_blank"); }

// --- Action Sheet ---
function showActionSheet(rowIndex, app) {
  const overlay = document.getElementById("actionOverlay");
  const sheet = document.getElementById("actionSheet");
  overlay.style.display = "block"; void overlay.offsetWidth; overlay.style.opacity = "1";
  sheet.style.transform = "translateY(0)";

  document.getElementById("btnEdit").onclick = () => {
    closeActionSheet(); setTimeout(() => openEdit(rowIndex, app), 300);
  };
  document.getElementById("btnDelete").onclick = () => {
    closeActionSheet(); setTimeout(() => deleteApp(rowIndex), 300);
  };
}

function closeActionSheet() {
  const overlay = document.getElementById("actionOverlay");
  const sheet = document.getElementById("actionSheet");
  sheet.style.transform = "translateY(120%)"; overlay.style.opacity = "0";
  setTimeout(() => { overlay.style.display = "none"; }, 300);
}

// --- CRUD Êìç‰Ωú ---
function fixUrl(url) {
  if (!url) return "";
  if (!/^https?:\/\//i.test(url)) return 'https://' + url;
  return url;
}

function openInputDialog(title, defaultName, defaultUrl, defaultEmoji, onConfirm) {
  const overlay = document.getElementById("inputOverlay");
  const dialog = document.getElementById("inputDialog");
  
  document.getElementById("dialogTitle").innerText = title;
  document.getElementById("inpName").value = defaultName || "";
  document.getElementById("inpUrl").value = defaultUrl || "";
  document.getElementById("inpEmoji").value = defaultEmoji || "üìå";

  const confirmBtn = document.getElementById("btnDialogConfirm");
  const newBtn = confirmBtn.cloneNode(true);
  confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
  
  newBtn.onclick = () => {
    const n = document.getElementById("inpName").value.trim();
    let u = document.getElementById("inpUrl").value.trim();
    const e = document.getElementById("inpEmoji").value.trim();
    if(!n || !u) { alert("ÂêçÁ®±ËàáÁ∂≤ÂùÄÁÇ∫ÂøÖÂ°´ÔºÅ"); return; }
    u = fixUrl(u);
    closeInputDialog();
    
    // È°ØÁ§∫ Loading
    document.getElementById("appList").innerHTML = "<div class='loading'>ËôïÁêÜ‰∏≠...</div>";
    onConfirm(n, u, e);
  };

  overlay.style.display = "block"; dialog.style.display = "flex";
  setTimeout(() => { overlay.style.opacity = "1"; dialog.style.opacity = "1"; dialog.style.transform = "translate(-50%, -50%) scale(1)"; }, 10);
}

function closeInputDialog() {
  const overlay = document.getElementById("inputOverlay");
  const dialog = document.getElementById("inputDialog");
  overlay.style.opacity = "0"; dialog.style.opacity = "0"; dialog.style.transform = "translate(-50%, -50%) scale(0.8)";
  setTimeout(() => { overlay.style.display = "none"; dialog.style.display = "none"; }, 250);
}

function openAdd() {
  openInputDialog("Êñ∞Â¢û App", "", "", "", (name, url, emoji) => {
    callApi('add', { name, url, emoji }).then(res => {
        if(res.status === 'success') loadApps();
        else alert('Êñ∞Â¢ûÂ§±Êïó');
    });
  });
}

function openEdit(rowIndex, app) {
  openInputDialog("Á∑®ËºØ App", app.name, app.url, app.emoji, (name, url, emoji) => {
    callApi('update', { rowIndex, name, url, emoji }).then(res => {
        if(res.status === 'success') loadApps();
        else alert('Êõ¥Êñ∞Â§±Êïó');
    });
  });
}

function deleteApp(rowIndex) {
  if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄã App ÂóéÔºü")) {
    document.getElementById("appList").innerHTML = "<div class='loading'>Âà™Èô§‰∏≠...</div>";
    callApi('delete', { rowIndex }).then(res => {
        if(res.status === 'success') loadApps();
        else alert('Âà™Èô§Â§±Êïó');
    });
  }
}
</script>
</body>
</html>